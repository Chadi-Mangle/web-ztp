{% extends "base_with_navbar.html" %}
{% load crispy_forms_tags %}

{% block fragment %}
<div class="section">
    {% crispy form %}
</div>

<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>

<script>
function maskToHosts(mask) {
    // Converts the mask to the number of network bits
    const parts = mask.split('.');
    let networkBits = 0;
    
    for (let part of parts) {
        const byte = parseInt(part);
        if (isNaN(byte)) return { min: 1, max: 254 }; 
        

        networkBits += (byte.toString(2).match(/1/g) || []).length;
    }
    
    const hostBits = 32 - networkBits;
    const maxHosts = Math.pow(2, hostBits) - 2;
    
    return {
        min: 1,
        max: maxHosts > 0 ? maxHosts : 254 
    };
}

$(document).ready(function() {
    function updateSlider() {
        const mask = $('#id_subnet').val();
        if (!mask || mask.split('.').length !== 4) return;
        
        const range = maskToHosts(mask);
        console.log("Masque:", mask, "Plage calcul√©e:", range); 
        
        const $slider = $("#slider-range");
        $slider.slider("option", "min", range.min);
        $slider.slider("option", "max", range.max);
        
        const values = $slider.slider("values");
        const newValues = [
            Math.max(range.min, values[0]),
            Math.min(range.max, values[1])
        ];
        $slider.slider("values", newValues);
        
        $("#ip-range").val(newValues[0] + " - " + newValues[1]);
        $("#id_min_ip_pool").val("0.0.0." + newValues[0]);
        $("#id_max_ip_pool").val("0.0.0." + newValues[1]);
    }

    $("#slider-range").slider({
        range: true,
        min: 1,
        max: 254,
        values: [1, 254],
        slide: function(event, ui) {
            $("#ip-range").val(ui.values[0] + " - " + ui.values[1]);
            $("#id_min_ip_pool").val("0.0.0." + ui.values[0]);
            $("#id_max_ip_pool").val("0.0.0." + ui.values[1]);
        }
    });
    
    $('#id_subnet').on('input', updateSlider);
    updateSlider(); 
});
</script>

<style>
.ip-range-slider {
    margin: 15px 0 40px; 
    height: 6px;
    background: #e9ecef;
    position: relative;
}
.ip-range-slider .ui-slider-handle {
    width: 16px;
    height: 16px;
    top: -5px;
    border: 2px solid #0D6EFD;
    background: white;
    border-radius: 50%;
}
.ip-range-slider .ui-slider-range {
    background: #0D6EFD;
}
.slider-min-label, .slider-max-label {
    font-size: 0.8rem;
    color: #6c757d;
    font-weight: bold;
}
#ip-range {
    border: 0;
    color: #000;
    font-weight: bold;
    background: transparent;
    width: 100%;
}
</style>
{% endblock %}